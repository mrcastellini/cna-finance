name: Backup de Dados - Tucuruvi
on:
  schedule:
    - cron: '0 0 * * *' # Todo dia à meia-noite
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions: # Garante que o robô pode escrever no repo
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Baixar Dados e Encriptar
        run: |
          # 1. Acorda o Render e espera ele subir
          curl -s ${{ vars.RENDER_API_URL }}/api/health > /dev/null
          sleep 30
          
          # 2. Baixa o JSON temporariamente
          curl -H "X-Admin-Token: ${{ secrets.MINHA_API_KEY }}" \
          ${{ vars.RENDER_API_URL }}/api/admin/export-db > backup_tucuruvi.json
          
          # 3. Encripta o arquivo usando a senha do Secret
          # O comando gera o arquivo 'backup_tucuruvi.json.gpg'
          echo "${{ secrets.BACKUP_PASSWORD }}" | gpg --batch --yes --passphrase-fd 0 -c backup_temp.json
          
          # 4. Apaga o JSON original (não queremos ele no histórico!)
          rm backup_tucuruvi.json

      - name: Push do Backup Protegido
        run: |
          git config --global user.name "Backup Bot"
          git config --global user.email "bot@github.com"
          git add backup_dados_tucuruvi.json.gpg
          git commit -m "Backup Encriptado: $(date)" || echo "Sem mudanças nos dados"
          git push origin main
